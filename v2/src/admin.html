<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBroker v2 - Admin</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #f0f0f0;
            border-color: #ccc;
            border-radius: 5px 5px 0 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .question-editor, .prompt-editor {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .question-item {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .question-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .textarea-sm {
            min-height: 60px;
        }
        
        .textarea-lg {
            min-height: 300px;
        }
        
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button.cancel {
            background-color: #f44336;
        }
        
        button.cancel:hover {
            background-color: #da190b;
        }
        
        .accordion {
            cursor: pointer;
            padding: 10px;
            width: 100%;
            text-align: left;
            background-color: #eee;
            border: none;
            outline: none;
            transition: 0.4s;
            margin-bottom: 10px;
        }
        
        .active-panel, .accordion:hover {
            background-color: #ccc;
        }
        
        .panel {
            padding: 0 10px;
            background-color: white;
            display: none;
            overflow: hidden;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <span class="logo-icon">âš¡</span>
                <h1>SmartBroker v2 - Admin Panel</h1>
            </div>
            <nav>
                <a href="index.html">Return to App</a>
            </nav>
        </div>
    </header>
    
    <main class="admin-container">
        <div id="notification"></div>
        
        <div class="tabs">
            <div class="tab active" data-tab="questions">Questions</div>
            <div class="tab" data-tab="prompts">Prompts</div>
        </div>
        
        <div id="questions-tab" class="tab-content active">
            <h2>Manage Questions</h2>
            <p>Edit or add questions that Claude uses for company research.</p>
            
            <button id="add-question-btn">Add New Question</button>
            
            <div id="question-form" style="display: none;" class="question-editor">
                <h3 id="question-form-title">Add New Question</h3>
                <form id="question-form-content">
                    <input type="hidden" id="question-index">
                    
                    <div class="form-group">
                        <label for="question-text">Question Text:</label>
                        <input type="text" id="question-text" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="question-positive-answer">Positive Answer:</label>
                        <input type="text" id="question-positive-answer" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="question-detailed-description">Detailed Description:</label>
                        <textarea id="question-detailed-description" class="textarea-sm"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="question-search-guidance">Search Guidance:</label>
                        <textarea id="question-search-guidance" class="textarea-sm"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="question-disqualification-criteria">Disqualification Criteria:</label>
                        <textarea id="question-disqualification-criteria" class="textarea-sm"></textarea>
                    </div>
                    
                    <div>
                        <button type="submit" id="question-save-btn">Save</button>
                        <button type="button" id="question-cancel-btn" class="cancel">Cancel</button>
                    </div>
                </form>
            </div>
            
            <div id="questions-list"></div>
        </div>
        
        <div id="prompts-tab" class="tab-content">
            <h2>Manage Prompts</h2>
            <p>Edit the system prompt and research prompt templates used by Claude.</p>
            
            <div class="prompt-editor">
                <h3>System Prompt</h3>
                <p>This is the system prompt that defines Claude's behavior during research.</p>
                
                <div class="form-group">
                    <textarea id="system-prompt" class="textarea-lg"></textarea>
                </div>
                
                <button id="save-system-prompt-btn">Save System Prompt</button>
            </div>
            
            <div class="prompt-editor">
                <h3>Research Prompt Template</h3>
                <p>This defines how research prompts are structured for each question and company.</p>
                
                <button class="accordion">Header and Company Identifiers</button>
                <div class="panel">
                    <div class="form-group">
                        <label for="header-template">Header Template:</label>
                        <textarea id="header-template" class="textarea-sm"></textarea>
                        <small>Use {companyName} as placeholder</small>
                    </div>
                    
                    <h4>Company Identifiers</h4>
                    <div class="form-group">
                        <label for="company-name-template">Company Name Template:</label>
                        <input type="text" id="company-name-template">
                        <small>Use {value} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="owner-template">Owner Template:</label>
                        <input type="text" id="owner-template">
                        <small>Use {value} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="title-template">Title Template:</label>
                        <input type="text" id="title-template">
                        <small>Use {value} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="location-template">Location Template:</label>
                        <input type="text" id="location-template">
                        <small>Use {value} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="website-template">Website Template:</label>
                        <input type="text" id="website-template">
                        <small>Use {value} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="linkedin-template">LinkedIn Template:</label>
                        <input type="text" id="linkedin-template">
                        <small>Use {value} as placeholder</small>
                    </div>
                </div>
                
                <button class="accordion">Previous Findings and Special Cases</button>
                <div class="panel">
                    <div class="form-group">
                        <label for="previous-findings-template">Previous Findings Template:</label>
                        <textarea id="previous-findings-template" class="textarea-sm"></textarea>
                        <small>Use {previousFindingsContent} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="owner-age-special-template">Owner Age Special Template:</label>
                        <textarea id="owner-age-special-template" class="textarea-sm"></textarea>
                        <small>Use {ownerName} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="question-section-template">Question Section Template:</label>
                        <textarea id="question-section-template" class="textarea-sm"></textarea>
                        <small>Use {questionText} as placeholder</small>
                    </div>
                </div>
                
                <button class="accordion">Question Details</button>
                <div class="panel">
                    <div class="form-group">
                        <label for="detailed-description-template">Detailed Description Template:</label>
                        <textarea id="detailed-description-template" class="textarea-sm"></textarea>
                        <small>Use {detailedDescription} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="search-guidance-template">Search Guidance Template:</label>
                        <textarea id="search-guidance-template" class="textarea-sm"></textarea>
                        <small>Use {searchGuidance} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="disqualification-criteria-template">Disqualification Criteria Template:</label>
                        <textarea id="disqualification-criteria-template" class="textarea-sm"></textarea>
                        <small>Use {disqualificationCriteria} as placeholder</small>
                    </div>
                </div>
                
                <button class="accordion">Answer Format</button>
                <div class="panel">
                    <div class="form-group">
                        <label for="answer-format-general-template">General Answer Format Template:</label>
                        <textarea id="answer-format-general-template" class="textarea-sm"></textarea>
                        <small>Use {positiveAnswer} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="answer-format-owner-name-template">Owner Name Answer Format Template:</label>
                        <textarea id="answer-format-owner-name-template" class="textarea-sm"></textarea>
                    </div>
                </div>
                
                <button class="accordion">Instructions</button>
                <div class="panel">
                    <div class="form-group">
                        <label for="important-instructions-template">Important Instructions Template:</label>
                        <textarea id="important-instructions-template" class="textarea-sm"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="owner-name-instructions-template">Owner Name Instructions Template:</label>
                        <textarea id="owner-name-instructions-template" class="textarea-sm"></textarea>
                        <small>Use {companyName} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="general-instructions-template">General Instructions Template:</label>
                        <textarea id="general-instructions-template" class="textarea-sm"></textarea>
                        <small>Use {positiveAnswer} as placeholder</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="final-instructions-template">Final Instructions Template:</label>
                        <textarea id="final-instructions-template" class="textarea-sm"></textarea>
                    </div>
                </div>
                
                <button id="save-prompts-btn">Save All Prompt Templates</button>
            </div>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and tab contents
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Set active class on clicked tab and corresponding tab content
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
            
            // Initialize accordions
            const accordions = document.querySelectorAll('.accordion');
            accordions.forEach(accordion => {
                accordion.addEventListener('click', function() {
                    this.classList.toggle('active-panel');
                    const panel = this.nextElementSibling;
                    if (panel.style.display === 'block') {
                        panel.style.display = 'none';
                    } else {
                        panel.style.display = 'block';
                    }
                });
            });
            
            // Questions tab functionality
            const questionsListElement = document.getElementById('questions-list');
            const questionForm = document.getElementById('question-form');
            const questionFormTitle = document.getElementById('question-form-title');
            const questionIndex = document.getElementById('question-index');
            const questionText = document.getElementById('question-text');
            const questionPositiveAnswer = document.getElementById('question-positive-answer');
            const questionDetailedDescription = document.getElementById('question-detailed-description');
            const questionSearchGuidance = document.getElementById('question-search-guidance');
            const questionDisqualificationCriteria = document.getElementById('question-disqualification-criteria');
            
            // Add question button
            document.getElementById('add-question-btn').addEventListener('click', () => {
                questionFormTitle.textContent = 'Add New Question';
                questionIndex.value = '';
                questionText.value = '';
                questionPositiveAnswer.value = '';
                questionDetailedDescription.value = '';
                questionSearchGuidance.value = '';
                questionDisqualificationCriteria.value = '';
                questionForm.style.display = 'block';
            });
            
            // Cancel question form
            document.getElementById('question-cancel-btn').addEventListener('click', () => {
                questionForm.style.display = 'none';
            });
            
            // Save question
            document.getElementById('question-form-content').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const question = {
                    text: questionText.value,
                    positiveAnswer: questionPositiveAnswer.value,
                    detailedDescription: questionDetailedDescription.value,
                    searchGuidance: questionSearchGuidance.value,
                    disqualificationCriteria: questionDisqualificationCriteria.value
                };
                
                try {
                    if (questionIndex.value === '') {
                        // Add new question
                        await fetch('/api/questions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(question)
                        });
                        showNotification('Question added successfully', 'success');
                    } else {
                        // Update existing question
                        await fetch(`/api/questions/${questionIndex.value}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(question)
                        });
                        showNotification('Question updated successfully', 'success');
                    }
                    
                    // Hide form and refresh questions list
                    questionForm.style.display = 'none';
                    loadQuestions();
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                }
            });
            
            // Load questions from API
            async function loadQuestions() {
                try {
                    const response = await fetch('/api/questions');
                    const questions = await response.json();
                    
                    // Clear questions list
                    questionsListElement.innerHTML = '';
                    
                    // Add each question to the list
                    questions.forEach((question, index) => {
                        const questionElement = document.createElement('div');
                        questionElement.className = 'question-item';
                        
                        const questionHeader = document.createElement('div');
                        questionHeader.className = 'question-header';
                        
                        const questionTitle = document.createElement('div');
                        questionTitle.className = 'question-title';
                        questionTitle.textContent = question.text;
                        
                        const questionActions = document.createElement('div');
                        questionActions.className = 'question-actions';
                        
                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit';
                        editButton.addEventListener('click', () => {
                            editQuestion(question, index);
                        });
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'cancel';
                        deleteButton.addEventListener('click', () => {
                            deleteQuestion(index);
                        });
                        
                        questionActions.appendChild(editButton);
                        questionActions.appendChild(deleteButton);
                        
                        questionHeader.appendChild(questionTitle);
                        questionHeader.appendChild(questionActions);
                        
                        questionElement.appendChild(questionHeader);
                        
                        // Add question details
                        const questionDetails = document.createElement('div');
                        questionDetails.innerHTML = `
                            <p><strong>Positive Answer:</strong> ${question.positiveAnswer}</p>
                            <p><strong>Detailed Description:</strong> ${question.detailedDescription || 'N/A'}</p>
                            <p><strong>Search Guidance:</strong> ${question.searchGuidance || 'N/A'}</p>
                            <p><strong>Disqualification Criteria:</strong> ${question.disqualificationCriteria || 'N/A'}</p>
                        `;
                        
                        questionElement.appendChild(questionDetails);
                        questionsListElement.appendChild(questionElement);
                    });
                } catch (error) {
                    showNotification(`Error loading questions: ${error.message}`, 'error');
                }
            }
            
            // Edit question
            function editQuestion(question, index) {
                questionFormTitle.textContent = 'Edit Question';
                questionIndex.value = index;
                questionText.value = question.text;
                questionPositiveAnswer.value = question.positiveAnswer;
                questionDetailedDescription.value = question.detailedDescription || '';
                questionSearchGuidance.value = question.searchGuidance || '';
                questionDisqualificationCriteria.value = question.disqualificationCriteria || '';
                questionForm.style.display = 'block';
            }
            
            // Delete question
            async function deleteQuestion(index) {
                if (confirm('Are you sure you want to delete this question?')) {
                    try {
                        await fetch(`/api/questions/${index}`, {
                            method: 'DELETE'
                        });
                        showNotification('Question deleted successfully', 'success');
                        loadQuestions();
                    } catch (error) {
                        showNotification(`Error deleting question: ${error.message}`, 'error');
                    }
                }
            }
            
            // Prompts tab functionality
            const systemPromptTextarea = document.getElementById('system-prompt');
            
            // Template elements
            const headerTemplate = document.getElementById('header-template');
            const companyNameTemplate = document.getElementById('company-name-template');
            const ownerTemplate = document.getElementById('owner-template');
            const titleTemplate = document.getElementById('title-template');
            const locationTemplate = document.getElementById('location-template');
            const websiteTemplate = document.getElementById('website-template');
            const linkedinTemplate = document.getElementById('linkedin-template');
            const previousFindingsTemplate = document.getElementById('previous-findings-template');
            const ownerAgeSpecialTemplate = document.getElementById('owner-age-special-template');
            const questionSectionTemplate = document.getElementById('question-section-template');
            const detailedDescriptionTemplate = document.getElementById('detailed-description-template');
            const searchGuidanceTemplate = document.getElementById('search-guidance-template');
            const disqualificationCriteriaTemplate = document.getElementById('disqualification-criteria-template');
            const answerFormatGeneralTemplate = document.getElementById('answer-format-general-template');
            const answerFormatOwnerNameTemplate = document.getElementById('answer-format-owner-name-template');
            const importantInstructionsTemplate = document.getElementById('important-instructions-template');
            const ownerNameInstructionsTemplate = document.getElementById('owner-name-instructions-template');
            const generalInstructionsTemplate = document.getElementById('general-instructions-template');
            const finalInstructionsTemplate = document.getElementById('final-instructions-template');
            
            // Load prompts from API
            async function loadPrompts() {
                try {
                    const response = await fetch('/api/prompts');
                    const prompts = await response.json();
                    
                    // System prompt
                    systemPromptTextarea.value = prompts.systemPrompt || '';
                    
                    // Research prompt templates
                    const templates = prompts.researchPromptTemplate || {};
                    
                    // Set template values
                    headerTemplate.value = templates.header || '';
                    
                    // Company identifiers
                    const identifiers = templates.companyIdentifiers || {};
                    companyNameTemplate.value = identifiers.companyName || '';
                    ownerTemplate.value = identifiers.owner || '';
                    titleTemplate.value = identifiers.title || '';
                    locationTemplate.value = identifiers.location || '';
                    websiteTemplate.value = identifiers.website || '';
                    linkedinTemplate.value = identifiers.linkedinUrl || '';
                    
                    // Previous findings and special cases
                    previousFindingsTemplate.value = templates.previousFindings || '';
                    ownerAgeSpecialTemplate.value = templates.ownerAgeSpecial || '';
                    questionSectionTemplate.value = templates.questionSection || '';
                    
                    // Question details
                    detailedDescriptionTemplate.value = templates.detailedDescription || '';
                    searchGuidanceTemplate.value = templates.searchGuidance || '';
                    disqualificationCriteriaTemplate.value = templates.disqualificationCriteria || '';
                    
                    // Answer format
                    const answerFormat = templates.answerFormat || {};
                    answerFormatGeneralTemplate.value = answerFormat.general || '';
                    answerFormatOwnerNameTemplate.value = answerFormat.ownerName || '';
                    
                    // Instructions
                    importantInstructionsTemplate.value = templates.importantInstructions || '';
                    ownerNameInstructionsTemplate.value = templates.ownerNameInstructions || '';
                    generalInstructionsTemplate.value = templates.generalInstructions || '';
                    finalInstructionsTemplate.value = templates.finalInstructions || '';
                } catch (error) {
                    showNotification(`Error loading prompts: ${error.message}`, 'error');
                }
            }
            
            // Save system prompt
            document.getElementById('save-system-prompt-btn').addEventListener('click', async () => {
                try {
                    const currentPrompts = await (await fetch('/api/prompts')).json();
                    
                    const updatedPrompts = {
                        ...currentPrompts,
                        systemPrompt: systemPromptTextarea.value
                    };
                    
                    await fetch('/api/prompts', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedPrompts)
                    });
                    
                    showNotification('System prompt saved successfully', 'success');
                } catch (error) {
                    showNotification(`Error saving system prompt: ${error.message}`, 'error');
                }
            });
            
            // Save all prompt templates
            document.getElementById('save-prompts-btn').addEventListener('click', async () => {
                try {
                    const currentPrompts = await (await fetch('/api/prompts')).json();
                    
                    const updatedPrompts = {
                        ...currentPrompts,
                        researchPromptTemplate: {
                            header: headerTemplate.value,
                            companyIdentifiers: {
                                companyName: companyNameTemplate.value,
                                owner: ownerTemplate.value,
                                title: titleTemplate.value,
                                location: locationTemplate.value,
                                website: websiteTemplate.value,
                                linkedinUrl: linkedinTemplate.value
                            },
                            previousFindings: previousFindingsTemplate.value,
                            ownerAgeSpecial: ownerAgeSpecialTemplate.value,
                            questionSection: questionSectionTemplate.value,
                            detailedDescription: detailedDescriptionTemplate.value,
                            searchGuidance: searchGuidanceTemplate.value,
                            disqualificationCriteria: disqualificationCriteriaTemplate.value,
                            answerFormat: {
                                general: answerFormatGeneralTemplate.value,
                                ownerName: answerFormatOwnerNameTemplate.value
                            },
                            importantInstructions: importantInstructionsTemplate.value,
                            ownerNameInstructions: ownerNameInstructionsTemplate.value,
                            generalInstructions: generalInstructionsTemplate.value,
                            finalInstructions: finalInstructionsTemplate.value
                        }
                    };
                    
                    await fetch('/api/prompts', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedPrompts)
                    });
                    
                    showNotification('Prompt templates saved successfully', 'success');
                } catch (error) {
                    showNotification(`Error saving prompt templates: ${error.message}`, 'error');
                }
            });
            
            // Show notification
            function showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.innerHTML = message;
                notification.className = type;
                
                // Hide notification after 3 seconds
                setTimeout(() => {
                    notification.innerHTML = '';
                    notification.className = '';
                }, 3000);
            }
            
            // Initial loads
            loadQuestions();
            loadPrompts();
        });
    </script>
</body>
</html>